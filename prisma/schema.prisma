generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model Account {
  id          String        @id @default(cuid())
  name        String
  institution String
  accountType String
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  transactions Transaction[]

  @@index([institution])
}

model Transaction {
  id           String   @id @default(cuid())
  accountId    String
  date         DateTime
  description  String
  amount       Float
  categoryId   String?
  originalData Json
  contentHash  String
  notes        String?
  parentId     String?
  importedAt   DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  account  Account   @relation(fields: [accountId], references: [id], onDelete: Cascade)
  category Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  parent   Transaction?  @relation("SplitTransactions", fields: [parentId], references: [id], onDelete: Cascade)
  splits   Transaction[] @relation("SplitTransactions")
  tags     TransactionTag[]

  @@unique([accountId, contentHash])
  @@index([accountId])
  @@index([date])
  @@index([categoryId])
  @@index([parentId])
}

model CSVMapping {
  id           String   @id @default(cuid())
  institution  String   @unique
  fieldMapping Json
  dateFormat   String
  invertAmount Boolean  @default(false)
  skipPatterns String[] @default([])
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model Category {
  id           String        @id @default(cuid())
  name         String        @unique
  keywords     String[]      @default([])
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  transactions Transaction[]
}

model ImportHistory {
  id           String   @id @default(cuid())
  fileName     String
  institution  String
  accountId    String?
  rowsImported Int
  importedAt   DateTime @default(now())
  createdAt    DateTime @default(now())
}

model Tag {
  id           String   @id @default(cuid())
  name         String   @unique
  isBigExpense Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  transactions TransactionTag[]
}

model TransactionTag {
  transactionId String
  tagId         String
  createdAt     DateTime @default(now())

  transaction Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  tag         Tag         @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([transactionId, tagId])
  @@index([tagId])
}

model WatchlistItem {
  id        String   @id @default(cuid())
  symbol    String   @unique
  name      String
  fundType  String   // "etf" | "mutual_fund" | "stock"
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model UserRole {
  id        String   @id @default(cuid())
  email     String   @unique
  role      String   @default("reader") // "admin" | "reader"
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
